# 第二课 课后作业：CLI 工程化自检

> 第二课讲了我们踩过的坑。这份作业帮你检查：你的系统有没有同样的问题？

---

## 作业目标

用下面的提示词，让 AI 帮你检查现有的 CLI 调用代码，找出潜在问题。

**适用场景**：
- 你已经有一个能跑的 CLI 调用实现
- 想知道它离"生产可用"还差多远
- 想避免踩我们踩过的坑

---

## 提示词

把下面这段提示词喂给 Claude（或其他 AI），让它帮你做自检：

```markdown
# CLI 调用代码自检

请帮我检查我的 CLI 子进程调用代码，看看有没有以下问题：

## 检查清单

### 1. stderr 活跃信号
- [ ] 超时检测是否同时监听了 stdout 和 stderr？
- [ ] CLI 在 thinking/工具调用时输出到 stderr，只监听 stdout 会误判超时

**问题代码示例**：
```javascript
// 只监听 stdout — 有 bug！
child.stdout.on('data', () => { lastActivity = Date.now(); });
```

**正确代码示例**：
```javascript
// 同时监听 stdout 和 stderr
child.stdout.on('data', () => { lastActivity = Date.now(); });
child.stderr.on('data', () => { lastActivity = Date.now(); });
```

### 2. 超时设置
- [ ] 超时时间是否合理？（复杂任务可能需要 10-30 分钟）
- [ ] 是否有任务级别的超时配置？
- [ ] 超时后的处理是否优雅？（先 SIGTERM，等几秒再 SIGKILL）

### 3. 进程生命周期
- [ ] 是否处理了 SIGTERM/SIGINT 信号？
- [ ] 父进程退出时，子进程是否会被正确清理？
- [ ] 是否有僵尸进程防护？

### 4. 流式解析
- [ ] NDJSON 解析是否处理了不完整行？
- [ ] 是否处理了粘包情况（多个 JSON 在一个 chunk 里）？
- [ ] 解析错误时是否有容错处理？

### 5. 环境隔离
- [ ] 开发环境和生产环境的数据库是否隔离？
- [ ] 是否有防止开发代码连接生产数据库的机制？
- [ ] 环境变量配置是否清晰？

### 6. 错误处理
- [ ] CLI 进程异常退出时如何处理？
- [ ] 是否有重试机制？
- [ ] 错误信息是否足够用于调试？

## 我的代码

[在这里粘贴你的 CLI 调用代码]

## 请帮我：

1. 逐项检查上述清单
2. 指出我的代码中存在的问题
3. 给出具体的修复建议
4. 如果某项检查通过，也请确认

输出格式：
- ✅ 通过的检查项
- ❌ 存在问题的检查项 + 问题描述 + 修复建议
- ⚠️ 无法确认的检查项（需要更多上下文）
```

---

## 使用方法

1. 复制上面的提示词
2. 把 `[在这里粘贴你的 CLI 调用代码]` 替换成你的实际代码
3. 喂给 Claude（或其他 AI）
4. 根据检查结果修复问题

---

## 验收标准

完成作业后，你的代码应该：

| 检查项 | 状态 |
|--------|------|
| stderr 和 stdout 都被监听 | ✅ |
| 超时时间可配置且合理 | ✅ |
| 进程生命周期管理完善 | ✅ |
| NDJSON 解析有容错 | ✅ |
| 开发/生产环境隔离 | ✅ |
| 错误处理完善 | ✅ |

---

## 进阶挑战

如果你想更进一步，可以尝试：

### 挑战 1：心跳机制

不用固定超时，改用心跳机制：
- CLI 定期输出心跳信号
- 超过 N 秒没收到心跳才判定超时
- 这样复杂任务也不会被误杀

### 挑战 2：优雅关机

实现两阶段关机：
```javascript
// 第一阶段：发 SIGTERM，让进程有机会清理
child.kill('SIGTERM');

// 等待 5 秒
setTimeout(() => {
  // 第二阶段：如果还没退出，强制 SIGKILL
  if (!child.killed) {
    child.kill('SIGKILL');
  }
}, 5000);
```

### 挑战 3：AI 幻觉检测

如果你的系统涉及 AI 回答问题：
- 设计一个"暗号测试"验证 AI 是否真的能获取信息
- 检查 AI 回答的正确性，而不只是"有没有回答"
- 在 system prompt 中强调"不确定时说不知道"

---

## 常见问题

**Q: 我用的不是 Node.js，这个检查清单还适用吗？**

A: 大部分检查项是语言无关的。stderr/stdout 的行为、超时处理、环境隔离这些概念在 Python、Go、Rust 等语言中同样适用。

**Q: 我的 CLI 工具不输出到 stderr，怎么办？**

A: 先确认一下。很多 CLI 工具在 verbose 模式下会输出到 stderr。如果确实不输出，那 stdout 单独监听就够了。但建议加上 stderr 监听作为防御性编程。

**Q: 超时时间应该设多长？**

A: 取决于你的任务复杂度。简单聊天可能 1-2 分钟够了，代码分析可能需要 10-30 分钟。建议做成可配置的，而不是硬编码。

---

*这份作业由布偶猫设计。踩过的坑，希望你不用再踩一遍。* 🐾
